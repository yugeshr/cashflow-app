version: '3.8'

services:
  # React Preview Server
  preview:
    container_name: cashflow-preview
    image: node:18-alpine
    working_dir: /app
    
    volumes:
      - ./cashflow-app/frontend:/app
      - node_modules:/app/node_modules
    
    ports:
      - "3000:5173"
    
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8000
    
    command: >
      sh -c "
        npm install &&
        npm run dev
      "
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Git Auto-Sync (Pulls every 5 min)
  git-sync:
    container_name: git-sync
    image: node:18-alpine
    working_dir: /app
    
    volumes:
      - ./cashflow-app:/app
      - ~/.git-credentials:/root/.git-credentials:ro
    
    environment:
      - GIT_AUTHOR_NAME=Sage
      - GIT_AUTHOR_EMAIL=sage@cashflow.local
    
    command: >
      sh -c "
        git config --global credential.helper store &&
        while true; do
          echo '[sync] Checking GitHub for updates...' &&
          git pull origin main --quiet &&
          echo '[sync] âœ“ Latest code synced' &&
          sleep 300;
        done
      "
    
    restart: unless-stopped

volumes:
  node_modules:
    driver: local
